<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refactored Interactive Retirement Calculator</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111827">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://unpkg.com/heroicons@1.0.6/dist/solid.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f9fafb; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #374151; }
        ::-webkit-scrollbar-thumb { background: #9CA3AF; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #D1D5DB; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ... 기존의 긴 리액트 코드는 그대로 ...
        const { useState, useEffect, useRef, useCallback } = React;

        // --- Initial Values ---
        const initialCrash = { id: 'crash_initial_1', startYear: 10, duration: 2, rate: 30 };
        const initialUnexpectedExpense = { id: 'ue_initial_1', year: 20, amount: 50000 };

        const initialValues = {
            initialInvestment: 1058360, monthlyExpense: 2200, healthInsurance: 400, travelExpense: 10000,
            investmentReturn: 5, expenseGrowth: 3, fixedSubsidy: 5000, variableSubsidy: 38000,
            subsidyGrowth: 3, variableSubsidyStartYear: 16, extraExpenseAmount: 50000, extraExpenseStartYear: 26,
            crashes: [{...initialCrash}],
            unexpectedExpenses: [{...initialUnexpectedExpense}]
        };
        const initialValues2 = {...initialValues, investmentReturn: 6.5, crashes: [{...initialCrash, id: 'crash_initial_2'}], unexpectedExpenses: [{...initialUnexpectedExpense, id: 'ue_initial_2'}]};

        const inputFields = [
            { key: 'initialInvestment', label: 'Initial Investment' }, { key: 'monthlyExpense', label: 'Monthly Basic Expenses' },
            { key: 'healthInsurance', label: 'Monthly Health Insurance' }, { key: 'travelExpense', label: 'Annual Travel Expenses' },
            { key: 'investmentReturn', label: 'Investment Return Rate', unit: '%' }, { key: 'expenseGrowth', label: 'Expense Inflation Rate', unit: '%' },
            { key: 'fixedSubsidy', label: 'Fixed Subsidy' }, { key: 'variableSubsidy', label: 'Variable Subsidy' },
            { key: 'subsidyGrowth', label: 'Subsidy Growth Rate (Variable)', unit: '%' }, { key: 'variableSubsidyStartYear', label: 'Variable Subsidy Start Year' },
            { key: 'extraExpenseAmount', label: 'Extra Expense Amount' }, { key: 'extraExpenseStartYear', label: 'Extra Expense Start Year' },
        ];

        // --- Helper & Plugin Section ---
        const formatCurrency = (amount) => new Intl.NumberFormat('en-CA', { style: 'currency', currency: 'CAD', minimumFractionDigits: 0 }).format(amount);
        
        const runSimulation = (currentInputs) => {
            let investment = currentInputs.initialInvestment;
            const yearlyData = [];
            const maxYears = 60;
            let fundDepletionYear = maxYears + 1;
            for (let year = 1; year <= maxYears; year++) {
                const startBalance = investment;
                const baseMonthlyExpense = (currentInputs.monthlyExpense || 0) * 12 * Math.pow(1 + (currentInputs.expenseGrowth || 0) / 100, year - 1);
                const healthInsuranceCost = (currentInputs.healthInsurance || 0) * 12 * Math.pow(1 + (currentInputs.expenseGrowth || 0) / 100, year - 1);
                const travelCost = (currentInputs.travelExpense || 0) * Math.pow(1 + (currentInputs.expenseGrowth || 0) / 100, year - 1);
                
                let totalExpense = baseMonthlyExpense + healthInsuranceCost + travelCost;
                
                if (year >= currentInputs.extraExpenseStartYear) {
                    totalExpense += (currentInputs.extraExpenseAmount || 0) * Math.pow(1 + (currentInputs.expenseGrowth || 0) / 100, year - currentInputs.extraExpenseStartYear);
                }

                if (currentInputs.unexpectedExpenses && currentInputs.unexpectedExpenses.length > 0) {
                    const unexpectedForYear = currentInputs.unexpectedExpenses.filter(ue => parseInt(ue.year, 10) === year);
                    if (unexpectedForYear.length > 0) {
                        const totalUnexpected = unexpectedForYear.reduce((sum, expense) => sum + (expense.amount || 0), 0);
                        totalExpense += totalUnexpected;
                    }
                }
                
                let totalSubsidy = (currentInputs.fixedSubsidy || 0);
                if (year >= currentInputs.variableSubsidyStartYear) totalSubsidy += (currentInputs.variableSubsidy || 0) * Math.pow(1 + (currentInputs.subsidyGrowth || 0) / 100, year - currentInputs.variableSubsidyStartYear);
                
                const netExpense = totalExpense - totalSubsidy;
                investment -= netExpense;

                if (investment > 0) {
                    const activeCrash = currentInputs.crashes.find(c => year >= (c.startYear||0) && year < (c.startYear||0) + (c.duration||0) && (c.duration||0) > 0 && (c.rate||0) > 0);
                    if (activeCrash) {
                        const annualFactor = Math.pow(1 - (activeCrash.rate || 0) / 100, 1 / (activeCrash.duration));
                        investment *= annualFactor;
                    } else {
                        investment *= (1 + (currentInputs.investmentReturn || 0) / 100);
                    }
                }
                if (investment <= 0 && fundDepletionYear > maxYears) fundDepletionYear = year;
                yearlyData.push({ year, startBalance: Math.round(startBalance), endBalance: Math.max(0, Math.round(investment)) });
            }
            return { yearlyData, fundDepletionYear };
        };
        
        const verticalLinePlugin = {
            id: 'verticalLine',
            afterDraw: chart => {
                if (chart.tooltip?._active?.length) {
                    const ctx = chart.ctx;
                    const x = chart.tooltip._active[0].element.x;
                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(x, chart.scales.y.top);
                    ctx.lineTo(x, chart.scales.y.bottom);
                    ctx.lineWidth = 1;
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                    ctx.stroke();
                    ctx.restore();
                }
            }
        };
        Chart.register(verticalLinePlugin);

        // --- Reusable Child Components ---
        const CrashInputGroup = ({ crashes, onCrashChange, onCommit, onAddCrash, onRemoveCrash }) => (
            <div className="mt-6">
                <h3 className="text-lg font-semibold text-gray-300 mb-3 border-b border-gray-700 pb-2">Market Crash Scenarios</h3>
                <div className="space-y-3">
                    {crashes.map((crash, index) => (
                         <div key={crash.id} className="grid grid-cols-10 gap-2 items-center">
                            <div className="col-span-3"><label className="text-xs text-gray-400">Crash Start Year</label><input type="number" step="any" value={crash.startYear} onChange={(e) => onCrashChange(index, 'startYear', e.target.value)} onBlur={onCommit} onKeyDown={onCommit} className="w-full mt-1 p-2 border bg-gray-700 border-gray-600 text-white rounded-md"/></div>
                            <div className="col-span-3"><label className="text-xs text-gray-400">Duration (Yrs)</label><input type="number" step="any" value={crash.duration} onChange={(e) => onCrashChange(index, 'duration', e.target.value)} onBlur={onCommit} onKeyDown={onCommit} className="w-full mt-1 p-2 border bg-gray-700 border-gray-600 text-white rounded-md"/></div>
                            <div className="col-span-3"><label className="text-xs text-gray-400">Total Rate (%)</label><input type="number" step="any" value={crash.rate} onChange={(e) => onCrashChange(index, 'rate', e.target.value)} onBlur={onCommit} onKeyDown={onCommit} className="w-full mt-1 p-2 border bg-gray-700 border-gray-600 text-white rounded-md"/></div>
                            <div className="col-span-1 pt-5"><button onClick
